console.log("Quiz script loaded");const l=document.getElementById("question-display");if(!l)throw console.error("Elemen #question-display tidak ditemukan."),new Error("Missing #question-display element");const p=parseInt(l.dataset.quizId||"0"),b=parseInt(l.dataset.resultId||"0"),$=l.dataset.timeRemaining==="null"?null:parseInt(l.dataset.timeRemaining,10),u=parseInt(l.dataset.totalQuestions||"0");console.log("Quiz Config:",{quizId:p,resultId:b,timeRemainingFromServer:$,totalQuestions:u});let g=null;try{const e=l.dataset.initialQuestion;e&&(g=JSON.parse(e),console.log("Initial question loaded:",g))}catch(e){console.error("Error parsing initialQuestion:",e)}let m={};try{const e=l.dataset.currentAnswers;e&&(m=JSON.parse(e),console.log("User answers loaded:",m))}catch(e){console.error("Error parsing userAnswers:",e)}let i=null,I,r=$,c=[],y=new Set;function _(){const e=document.getElementById("questionGrid");e&&(e.innerHTML=L(),console.log("Question grid populated")),E(),B()}function L(){let e="";for(let t=1;t<=u;t++)e+=`
            <div class="question-card" 
                 onclick="goToQuestionCard(${t})"
                 id="nav-card-${t}"
                 data-question="${t}"
                 title="Question ${t}">
                <span class="card-number">${t}</span>
            </div>
        `;return e}function q(e,t){const n=document.getElementById(`nav-card-${e}`);n&&(n.classList.remove("current","answered","unanswered"),t&&n.classList.add(t))}function E(){const e=y.size,t=e/u*100,n=document.getElementById("progressCount"),o=document.getElementById("progressFill");n&&(n.textContent=`${e}/${u}`),o&&(o.style.width=`${t}%`)}function Q(e){y.add(e),q(e,"answered"),E()}function T(e){y.delete(e),q(e,"unanswered"),E()}function S(e){document.querySelectorAll(".question-card").forEach(t=>{t.classList.remove("current")}),q(e,"current")}window.toggleQuestionNav=function(){if(window.innerWidth>=1024)return;const e=document.getElementById("questionNavigationCard"),t=document.getElementById("navOverlay");e&&t&&(e.classList.toggle("show"),t.classList.toggle("show"),document.body.classList.toggle("nav-open"))};window.goToQuestionCard=async function(e){console.log(`Navigation card ${e} clicked`),window.innerWidth<1024&&toggleQuestionNav(),v();try{await w(),await x(e)}catch(t){console.error("Error during card navigation:",t),alert("Terjadi kesalahan saat berpindah soal")}finally{h()}};function B(){document.addEventListener("keydown",e=>{if(e.key==="Escape"&&window.innerWidth<1024){const t=document.getElementById("questionNavigationCard");t&&t.classList.contains("show")&&toggleQuestionNav()}}),window.addEventListener("resize",()=>{if(window.innerWidth>=1024){const e=document.getElementById("questionNavigationCard"),t=document.getElementById("navOverlay");e&&e.classList.remove("show"),t&&t.classList.remove("show"),document.body.classList.remove("nav-open")}})}function f(){if(r===null)return;const e=Math.floor(r/60),t=r%60,n=document.getElementById("quiz-timer");n&&(n.textContent=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`)}function C(){if(r===null||r<=0){f();return}f(),I=setInterval(()=>{r--,f(),r<=0&&(clearInterval(I),alert("Waktu quiz habis! Quiz akan diselesaikan."),window.location.href=`/quiz/${p}/result`)},1e3)}function z(e){let t="";const n=Array.isArray(e.options)?e.options:[];return e.question_type==="multiple_choice"&&n.length>0?n.forEach((o,a)=>{const s=`q${e.id}-option${a}`;t+=`
                <label for="${s}" class="block mb-2 cursor-pointer p-3 rounded-md border border-gray-700 hover:bg-gray-700 transition duration-200 ease-in-out">
                    <input type="radio" id="${s}" name="user_answer" value="${o}" class="mr-3 transform scale-125 accent-blue-500">
                    ${o}
                </label>
            `}):t+='<textarea name="user_answer" class="w-full mt-2 p-3 border border-gray-700 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" rows="6" placeholder="Tulis jawaban Anda di sini..."></textarea>',t}function A(){const e=document.getElementById("answer-input-area");if(!e)return null;const t=i.question_type;let n=null;if(t==="multiple_choice"){const o=e.querySelector('input[name="user_answer"]:checked');o&&(n=o.value)}else{const o=e.querySelector('textarea[name="user_answer"]');o&&(n=o.value)}return n}function M(){if(!i)return;const e=i.question_number,t=document.getElementById("prev-question-btn"),n=document.getElementById("next-question-btn");!t||!n||(t.classList.toggle("hidden",e===1),e===u?(n.innerHTML='Selesai <i class="fas fa-check ml-2"></i>',n.classList.remove("bg-blue-600","hover:bg-blue-700"),n.classList.add("bg-green-600","hover:bg-green-700")):(n.innerHTML='Selanjutnya <i class="fas fa-arrow-right ml-2"></i>',n.classList.remove("bg-green-600","hover:bg-green-700"),n.classList.add("bg-blue-600","hover:bg-blue-700")))}async function w(){if(!i)return!1;let e=A();e!==null&&e.trim()===""&&(e=null),console.log("Saving answer for question",i.id,":",e),m[i.id]=e,e!==null&&e.trim()!==""?Q(i.question_number):T(i.question_number);try{const n=(await fetch(`/quiz/${p}/submit-answer`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({question_id:i.id,user_answer:e,result_id:b})})).ok;return console.log("Answer save result:",n),n}catch(t){return console.error("Gagal menyimpan jawaban:",t),!1}}function v(){const e=document.querySelectorAll("#prev-question-btn, #next-question-btn, .question-card");e.forEach(t=>{t.disabled=!0,t.classList.add("opacity-50","cursor-not-allowed"),t.style.pointerEvents="none"}),console.log("Disabled",e.length,"navigation buttons")}function h(){const e=document.querySelectorAll("#prev-question-btn, #next-question-btn, .question-card");e.forEach(t=>{t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed"),t.style.pointerEvents="auto"}),console.log("Enabled",e.length,"navigation buttons")}async function k(e){if(console.log("Displaying question:",e.question_number),!e||!e.id){const s=document.getElementById("current-question-content");s&&(s.innerHTML='<p class="text-center text-red-500 text-lg mt-8">Gagal memuat soal. Data pertanyaan tidak valid.</p>');return}i=e;const t=document.getElementById("current-question-content");if(!t)return;t.innerHTML='<p class="text-center text-lg mt-8 text-gray-400">Memuat soal...</p>',await new Promise(s=>setTimeout(s,100));const n=`
        <p class="font-semibold mb-4 text-xl text-blue-300">
            <span class="text-gray-400 mr-2">${e.question_number}.</span> ${e.question_text||""}
        </p>
        ${e.image?`<img src="/storage/${e.image}" alt="Question Image" class="mb-4 w-full max-w-lg mx-auto rounded-lg shadow-md">`:""}
        ${e.question_file?`
            <a href="/storage/${e.question_file}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg my-4 transition duration-300 ease-in-out">
                <i class="fas fa-download mr-2"></i> Lihat/Unduh File Soal
            </a>
        `:""}
        <div class="mt-4" id="answer-input-area">${z(e)}</div>
    `;t.innerHTML=n;const o=document.getElementById("question-number"),a=document.getElementById("total-questions");if(o&&(o.textContent=e.question_number),a&&(a.textContent=u),m[e.id]){const s=m[e.id];if(console.log("Pre-filling answer:",s),e.question_type==="multiple_choice"){const d=t.querySelector(`input[type="radio"][value="${s}"]`);d&&(d.checked=!0)}else{const d=t.querySelector('textarea[name="user_answer"]');d&&(d.value=s)}}S(e.question_number),M(),console.log("Question displayed successfully:",e.question_number)}async function x(e){if(console.log(`Navigating to question ${e}`),!e||e<1||e>u){console.error("Invalid question number:",e);return}let t=c.find(n=>n.question_number===e);if(t)console.log(`Question ${e} found in cache`);else{console.log(`Question ${e} not in cache, fetching from server...`);const n=document.getElementById("current-question-content");n&&(n.innerHTML=`<p class="text-center text-lg mt-8 text-gray-400">Memuat soal no. ${e}...</p>`);try{const o=await fetch(`/quiz/${p}/get-question/${e}`);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const a=await o.json();if(console.log("Received question from server:",a),!a||!a.id)throw new Error("Invalid question data received from server");c.push(a),c.sort((s,d)=>s.question_number-d.question_number),t=a,console.log("Question added to cache, cache size:",c.length)}catch(o){console.error("Failed to fetch question:",o),alert(`Tidak bisa memuat soal no. ${e}. Error: ${o.message}`);return}}t?(await k(t),console.log(`Successfully navigated to question ${e}`)):console.error("Target question is null after processing")}async function N(){if(!i)return;const e=i.question_number;if(console.log("Next button clicked, current question:",e),e===u){console.log("Finishing quiz...");try{const t=await fetch(`/quiz/result/${b}/finalize`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}),n=await t.json();t.ok?(alert("Quiz Selesai!"),window.location.href=n.redirect_url):alert("Gagal menyelesaikan kuis.")}catch(t){console.error("Error finalizing quiz:",t),alert("Terjadi error saat menyelesaikan kuis.")}}else await x(e+1)}async function O(){if(!i)return;const e=i.question_number;console.log("Previous button clicked, current question:",e),e>1&&await x(e-1)}document.addEventListener("DOMContentLoaded",()=>{console.log("DOM loaded, initializing quiz...");try{const n=l.dataset.questionCache;if(n){const o=JSON.parse(n);Array.isArray(o)&&(c=o,c.sort((a,s)=>a.question_number-s.question_number),console.log("Questions cache loaded:",c.length,"questions"))}}catch(n){console.error("Error parsing questionsCache from data attribute:",n)}if(_(),c.forEach(n=>{m[n.id]&&m[n.id].trim()!==""&&y.add(n.question_number)}),!g||!g.id){console.error("Invalid initial question:",g);const n=document.getElementById("current-question-content");n&&(n.innerHTML='<p class="text-center text-red-500 text-lg mt-8">Gagal memuat soal awal. Mohon coba lagi.</p>');return}if(k(g),console.log("Initial question displayed"),r!==null&&r>0)C();else{f();const n=document.getElementById("quiz-timer");r===null&&n&&(n.textContent="Tidak Terbatas")}const e=document.getElementById("next-question-btn"),t=document.getElementById("prev-question-btn");e&&(e.addEventListener("click",async n=>{n.preventDefault(),console.log("Next button clicked"),v(),await w(),await N(),h()}),console.log("Next button listener attached")),t&&(t.addEventListener("click",async n=>{n.preventDefault(),console.log("Previous button clicked"),v(),await w(),await O(),h()}),console.log("Previous button listener attached")),console.log("Quiz initialization complete")});
