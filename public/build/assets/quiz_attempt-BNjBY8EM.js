console.log("Quiz script loaded");const u=document.getElementById("question-display");if(!u)throw console.error("Elemen #question-display tidak ditemukan."),new Error("Missing #question-display element");const p=parseInt(u.dataset.quizId||"0"),q=parseInt(u.dataset.resultId||"0"),x=u.dataset.timeRemaining==="null"?null:parseInt(u.dataset.timeRemaining,10),m=parseInt(u.dataset.totalQuestions||"0");console.log("Quiz Config:",{quizId:p,resultId:q,timeRemainingFromServer:x,totalQuestions:m});let d=null;try{const e=u.dataset.initialQuestion;e&&(d=JSON.parse(e),console.log("Initial question loaded:",d))}catch(e){console.error("Error parsing initialQuestion:",e)}let g={};try{const e=u.dataset.currentAnswers;e&&(g=JSON.parse(e),console.log("User answers loaded:",g))}catch(e){console.error("Error parsing userAnswers:",e)}let a=null,v,l=x,c=[];function f(){if(l===null)return;const e=Math.floor(l/60),n=l%60,t=document.getElementById("quiz-timer");t&&(t.textContent=`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`)}function I(){if(l===null||l<=0){f();return}f(),v=setInterval(()=>{l--,f(),l<=0&&(clearInterval(v),alert("Waktu quiz habis! Quiz akan diselesaikan."),window.location.href=`/quiz/${p}/result`)},1e3)}function $(e){let n="";const t=Array.isArray(e.options)?e.options:[];return e.question_type==="multiple_choice"&&t.length>0?t.forEach((o,i)=>{const s=`q${e.id}-option${i}`;n+=`
                <label for="${s}" class="block mb-2 cursor-pointer p-3 rounded-md border border-gray-700 hover:bg-gray-700 transition duration-200 ease-in-out">
                    <input type="radio" id="${s}" name="user_answer" value="${o}" class="mr-3 transform scale-125 accent-blue-500">
                    ${o}
                </label>
            `}):n+='<textarea name="user_answer" class="w-full mt-2 p-3 border border-gray-700 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" rows="6" placeholder="Tulis jawaban Anda di sini..."></textarea>',n}function _(){const e=document.getElementById("answer-input-area");if(!e)return null;const n=a.question_type;let t=null;if(n==="multiple_choice"){const o=e.querySelector('input[name="user_answer"]:checked');o&&(t=o.value)}else{const o=e.querySelector('textarea[name="user_answer"]');o&&(t=o.value)}return t}function k(){if(!a)return;const e=a.question_number,n=document.getElementById("prev-question-btn"),t=document.getElementById("next-question-btn");!n||!t||(n.classList.toggle("hidden",e===1),e===m?(t.innerHTML='Selesai <i class="fas fa-check ml-2"></i>',t.classList.remove("bg-blue-600","hover:bg-blue-700"),t.classList.add("bg-green-600","hover:bg-green-700")):(t.innerHTML='Selanjutnya <i class="fas fa-arrow-right ml-2"></i>',t.classList.remove("bg-green-600","hover:bg-green-700"),t.classList.add("bg-blue-600","hover:bg-blue-700")))}function T(){if(console.log("Rendering pagination for question:",a==null?void 0:a.question_number),!a)return;const e=document.getElementById("question-pagination");if(!e){console.error("Pagination container not found!");return}let n="";for(let t=1;t<=m;t++){const o=t===a.question_number?"bg-blue-500 text-white":"bg-gray-700 hover:bg-gray-600 text-gray-300",i=c.find(r=>r.question_number===t),s=i&&g[i.id]?"border-blue-400 border-2":"";n+=`<button type="button" data-question-number="${t}" class="question-page-btn w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${o} ${s} transition duration-200 ease-in-out cursor-pointer">${t}</button>`}e.innerHTML=n,console.log("Pagination HTML set, attaching listeners..."),S()}function S(){const e=document.querySelectorAll(".question-page-btn");console.log("Found pagination buttons:",e.length),e.forEach((n,t)=>{const o=n.cloneNode(!0);n.parentNode.replaceChild(o,n),o.addEventListener("click",async function(i){i.preventDefault(),i.stopPropagation();const s=parseInt(this.dataset.questionNumber);if(console.log(`Pagination button ${s} clicked`),isNaN(s)){console.error("Invalid question number:",this.dataset.questionNumber);return}h();try{await b(),await w(s)}catch(r){console.error("Error during navigation:",r),alert("Terjadi kesalahan saat berpindah soal")}finally{y()}}),o.addEventListener("mousedown",function(){this.style.transform="scale(0.95)"}),o.addEventListener("mouseup",function(){this.style.transform="scale(1)"}),o.addEventListener("mouseleave",function(){this.style.transform="scale(1)"})}),console.log("Event listeners attached to",e.length,"pagination buttons")}async function b(){if(!a)return!1;let e=_();e!==null&&e.trim()===""&&(e=null),console.log("Saving answer for question",a.id,":",e),g[a.id]=e;try{const t=(await fetch(`/quiz/${p}/submit-answer`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({question_id:a.id,user_answer:e,result_id:q})})).ok;return console.log("Answer save result:",t),t}catch(n){return console.error("Gagal menyimpan jawaban:",n),!1}}function h(){const e=document.querySelectorAll("#prev-question-btn, #next-question-btn, .question-page-btn");e.forEach(n=>{n.disabled=!0,n.classList.add("opacity-50","cursor-not-allowed")}),console.log("Disabled",e.length,"navigation buttons")}function y(){const e=document.querySelectorAll("#prev-question-btn, #next-question-btn, .question-page-btn");e.forEach(n=>{n.disabled=!1,n.classList.remove("opacity-50","cursor-not-allowed")}),console.log("Enabled",e.length,"navigation buttons")}async function E(e){if(console.log("Displaying question:",e.question_number),!e||!e.id){const s=document.getElementById("current-question-content");s&&(s.innerHTML='<p class="text-center text-red-500 text-lg mt-8">Gagal memuat soal. Data pertanyaan tidak valid.</p>');return}a=e;const n=document.getElementById("current-question-content");if(!n)return;n.innerHTML='<p class="text-center text-lg mt-8 text-gray-400">Memuat soal...</p>',await new Promise(s=>setTimeout(s,100));const t=`
        <p class="font-semibold mb-4 text-xl text-blue-300">
            <span class="text-gray-400 mr-2">${e.question_number}.</span> ${e.question_text||""}
        </p>
        ${e.image?`<img src="/storage/${e.image}" alt="Question Image" class="mb-4 w-full max-w-lg mx-auto rounded-lg shadow-md">`:""}
        ${e.question_file?`
            <a href="/storage/${e.question_file}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg my-4 transition duration-300 ease-in-out">
                <i class="fas fa-download mr-2"></i> Lihat/Unduh File Soal
            </a>
        `:""}
        <div class="mt-4" id="answer-input-area">${$(e)}</div>
    `;n.innerHTML=t;const o=document.getElementById("question-number"),i=document.getElementById("total-questions");if(o&&(o.textContent=e.question_number),i&&(i.textContent=m),g[e.id]){const s=g[e.id];if(console.log("Pre-filling answer:",s),e.question_type==="multiple_choice"){const r=n.querySelector(`input[type="radio"][value="${s}"]`);r&&(r.checked=!0)}else{const r=n.querySelector('textarea[name="user_answer"]');r&&(r.value=s)}}k(),T(),console.log("Question displayed successfully:",e.question_number)}async function w(e){if(console.log(`Navigating to question ${e}`),!e||e<1||e>m){console.error("Invalid question number:",e);return}let n=c.find(t=>t.question_number===e);if(n)console.log(`Question ${e} found in cache`);else{console.log(`Question ${e} not in cache, fetching from server...`);const t=document.getElementById("current-question-content");t&&(t.innerHTML=`<p class="text-center text-lg mt-8 text-gray-400">Memuat soal no. ${e}...</p>`);try{const o=await fetch(`/quiz/${p}/get-question/${e}`);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const i=await o.json();if(console.log("Received question from server:",i),!i||!i.id)throw new Error("Invalid question data received from server");c.push(i),c.sort((s,r)=>s.question_number-r.question_number),n=i,console.log("Question added to cache, cache size:",c.length)}catch(o){console.error("Failed to fetch question:",o),alert(`Tidak bisa memuat soal no. ${e}. Error: ${o.message}`);return}}n?(await E(n),console.log(`Successfully navigated to question ${e}`)):console.error("Target question is null after processing")}async function A(){if(!a)return;const e=a.question_number;if(console.log("Next button clicked, current question:",e),e===m){console.log("Finishing quiz...");try{const n=await fetch(`/quiz/result/${q}/finalize`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}),t=await n.json();n.ok?(alert("Quiz Selesai!"),window.location.href=t.redirect_url):alert("Gagal menyelesaikan kuis.")}catch(n){console.error("Error finalizing quiz:",n),alert("Terjadi error saat menyelesaikan kuis.")}}else await w(e+1)}async function z(){if(!a)return;const e=a.question_number;console.log("Previous button clicked, current question:",e),e>1&&await w(e-1)}document.addEventListener("DOMContentLoaded",()=>{console.log("DOM loaded, initializing quiz...");try{const t=u.dataset.questionCache;if(t){const o=JSON.parse(t);Array.isArray(o)&&(c=o,c.sort((i,s)=>i.question_number-s.question_number),console.log("Questions cache loaded:",c.length,"questions"))}}catch(t){console.error("Error parsing questionsCache from data attribute:",t)}if(!d||!d.id){console.error("Invalid initial question:",d);const t=document.getElementById("current-question-content");t&&(t.innerHTML='<p class="text-center text-red-500 text-lg mt-8">Gagal memuat soal awal. Mohon coba lagi.</p>');return}if(E(d),console.log("Initial question displayed"),l!==null&&l>0)I();else{f();const t=document.getElementById("quiz-timer");l===null&&t&&(t.textContent="Tidak Terbatas")}const e=document.getElementById("next-question-btn"),n=document.getElementById("prev-question-btn");e&&(e.addEventListener("click",async t=>{t.preventDefault(),console.log("Next button clicked"),h(),await b(),await A(),y()}),console.log("Next button listener attached")),n&&(n.addEventListener("click",async t=>{t.preventDefault(),console.log("Previous button clicked"),h(),await b(),await z(),y()}),console.log("Previous button listener attached")),console.log("Quiz initialization complete")});
